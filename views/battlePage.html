<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styleBattlePage.css">
    <title>Battle!</title>
</head>
<body>
    <div id="turnAnnouncement" class="hidden"></div>
    <div id="turnStatus">Waiting for turn...</div>
    <div id="turnTimer">30</div>
    <button id="endTurn">End Turn</button>
    <button id="giveUpButton">Give Up</button>
    <div class="musicControlContainer">
    <button id="musicToggle" class="music-button">ðŸ”Š</button>
    <div id="newCards"></div>
    <div class="volume-popup hidden" id="volumePopup">
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
    </div>
    </div>
    <div id="mainContainer">
        <div id="opponentSide">
            <div id="opponentInfo">
                <div id="opponent">
                    <div class="player-info">
                        <div id="opponentAvatar" class="avatar"></div>
                        <div id="opponentLogin"></div>
                        <div id="opponentHP" class="player-hp"></div>
                    </div>
                </div>
                <div id="opponentHand"></div>
            </div>
            <div id="opponentTable"></div>
        </div>
        <div id="userSide">
            <div id="userTable"></div>
            <div id="userInfo">
                <div id="user">
                    <div class="player-info">
                        <div id="userAvatar" class="avatar"></div>
                        <div id="userLogin"></div>
                        <div id="userHP" class="player-hp"></div>
                    </div>
                </div>
                <div id="userHand"></div>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="module" src="/battlePageScript.js"></script>
    <audio id="bgMusic" preload="auto" loop>
        <source src="/audio/battlebg-music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
        const music = document.getElementById("bgMusic");
        const toggleBtn = document.getElementById("musicToggle");
        const volumeSlider = document.getElementById("volumeSlider");
        const volumePopup = document.getElementById("volumePopup");

        let savedVolume = localStorage.getItem("musicVolume") || "0.5";
        let savedPlaying = localStorage.getItem("musicPlaying") || "true";

        music.volume = parseFloat(savedVolume);
        volumeSlider.value = savedVolume;

        let isMuted = savedPlaying === "false";

        const updateIcon = () => {
            toggleBtn.textContent = isMuted ? "ðŸ”ˆ" : (music.volume == 0 ? "ðŸ”ˆ" : "ðŸ”Š");
        };

        // Variables to track hover state for button and popup
        let isOverButton = false;
        let isOverPopup = false;

        // Show popup when hovering the button
        toggleBtn.addEventListener("mouseenter", () => {
            isOverButton = true;
            volumePopup.classList.remove("hidden");
        });

        // Hide popup when leaving the button (if not over popup)
        toggleBtn.addEventListener("mouseleave", () => {
            isOverButton = false;
            setTimeout(() => {
                if (!isOverPopup && !isOverButton) {
                    volumePopup.classList.add("hidden");
                }
            }, 100);
        });

        // Keep popup visible if mouse is over it
        volumePopup.addEventListener("mouseenter", () => {
            isOverPopup = true;
            volumePopup.classList.remove("hidden");
        });

        // Hide popup when leaving popup (if not over button)
        volumePopup.addEventListener("mouseleave", () => {
            isOverPopup = false;
            setTimeout(() => {
                if (!isOverPopup && !isOverButton) {
                    volumePopup.classList.add("hidden");
                }
            }, 100);
        });

        // Toggle mute/unmute on button click
        toggleBtn.addEventListener("click", () => {
            isMuted = !isMuted;
            if (isMuted) {
                music.pause();
                localStorage.setItem("musicPlaying", "false");
            } else {
                music.play().catch(err => console.warn("Playback failed:", err));
                localStorage.setItem("musicPlaying", "true");
            }
            updateIcon();
        });

        // Change volume on slider input
        volumeSlider.addEventListener("input", () => {
            const volume = parseFloat(volumeSlider.value);
            music.volume = volume;
            localStorage.setItem("musicVolume", volume);
            updateIcon();
        });

        // Try to autoplay music if allowed
        const unlockAudio = () => {
            if (localStorage.getItem("musicPlaying") === "true") {
                music.play().catch(err => console.warn("Autoplay blocked:", err));
            }
            document.removeEventListener("click", unlockAudio);
        };
        document.addEventListener("click", unlockAudio, { once: true });

        if (!isMuted && savedPlaying === "true") {
            music.play().catch(() => {}); // Silent fail on autoplay block
        }

        updateIcon();
    });

    </script>
</body>
</html>